# MOSS-Speech ä¼˜åŒ–è¿›å±•æŠ¥å‘Š

## ğŸ“… æ—¥æœŸ: 2026-01-14

## âœ… å·²å®Œæˆ

### 1. TensorRT-LLM ç¯å¢ƒé…ç½®
- **tensorrt-llm**: v0.13.0 âœ…
- **tensorrt**: v10.4.0 âœ…
- **CUDA**: 12.4 âœ…
- **GPU**: NVIDIA RTX 4090 âœ…

> æ³¨æ„: ä¿®è¡¥äº† `profiler.py` ä¸­çš„ pynvml å…¼å®¹æ€§é—®é¢˜

### 2. MOSS-Speech æ¨¡å‹ä¸‹è½½
- **ä»“åº“**: `OpenMOSS-Team/MOSS-Speech`
- **å¤§å°**: ~17GB (4ä¸ª safetensors åˆ†ç‰‡)
- **çŠ¶æ€**: âœ… å®Œæˆ

### 3. æ¶æ„åˆ†æ

MOSS-Speech ä½¿ç”¨ **Layer-Splitting** æ¶æ„ (éä¼ ç»Ÿ Flow-matching):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        MOSS-Speech æ¶æ„                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     embed_tokens + audio_embed    â”‚  â”‚
â”‚  â”‚        (è¯åµŒå…¥ + éŸ³é¢‘åµŒå…¥)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        shared_block               â”‚  â”‚
â”‚  â”‚     (32å±‚å…±äº« Transformer)         â”‚  â”‚
â”‚  â”‚      - è¿™æ˜¯ Qwen Backbone         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â”‚                      â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚               â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ text_block  â”‚ â”‚ audio_block â”‚       â”‚
â”‚  â”‚ (4å±‚æ–‡æœ¬)   â”‚ â”‚  (4å±‚éŸ³é¢‘)   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚               â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ text_norm   â”‚ â”‚ audio_norm  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚               â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  text_head  â”‚ â”‚ audio_head  â”‚       â”‚
â”‚  â”‚ (æ–‡æœ¬è¾“å‡º)  â”‚ â”‚ (éŸ³é¢‘ Token) â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®å‚æ•°
| å‚æ•° | å€¼ |
|------|-----|
| hidden_size | 4096 |
| num_hidden_layers | 36 |
| num_shared_layers | 32 |
| num_modality_layers | 4 |
| num_attention_heads | 32 |
| num_key_value_heads | 8 (GQA) |
| audio_vocab_size | 16512 |

## ğŸ”„ è¿›è¡Œä¸­

### æ¨¡å‹åŠ è½½éªŒè¯ âœ…

æˆåŠŸä½¿ç”¨ `transformers` + `trust_remote_code=True` åŠ è½½:

```python
model = AutoModel.from_pretrained(
    "/tmp/MOSS-Speech",
    trust_remote_code=True,
    torch_dtype=torch.bfloat16,
    device_map="auto"
)
```

**ç»“æœ**:
- æ˜¾å­˜ä½¿ç”¨: **18.19 GB** (bfloat16)
- å‚æ•°é‡: **9.10B**

### å‚æ•°åˆ†å¸ƒè¯¦æƒ…

| ç»„ä»¶ | å‚æ•°é‡ | å±‚æ•° | è¯´æ˜ |
|------|--------|------|------|
| shared_block | 6.17B | 32 | å…±äº« Transformer éª¨å¹² |
| text_block | 771.8M | 4 | æ–‡æœ¬ä¸“ç”¨å±‚ |
| audio_block | 771.8M | 4 | éŸ³é¢‘ä¸“ç”¨å±‚ |
| embed_tokens | 621.3M | - | æ–‡æœ¬åµŒå…¥ (vocab=151680) |
| audio_embed | 67.6M | - | éŸ³é¢‘åµŒå…¥ (vocab=16512) |
| text_lm_head | ~620M | - | 4096 â†’ 151680 |
| audio_lm_head | ~68M | - | 4096 â†’ 16512 |

### Phase 2: TensorRT è½¬æ¢æ–¹æ¡ˆ

**é‡è¦**: MOSS-Speech æ˜¯çº¯ Transformerï¼Œæ—  Flow-matchingï¼

#### æ¨è: ONNX â†’ TensorRT
1. å¯¼å‡ºä¸º ONNX
2. `trtexec --onnx=moss.onnx --saveEngine=moss.engine --fp16`
3. è‡ªå®šä¹‰æ¨ç†å¾ªç¯å¤„ç†åŒè¾“å‡ºå¤´

## ğŸ‰ TensorRT-LLM Engine æ„å»ºæˆåŠŸ

### æ„å»ºç»“æœ

| é¡¹ç›® | å€¼ |
|-----|-----|
| Engine å¤§å° | **6.3 GB** |
| æ„å»ºæ—¶é—´ | ~10 åˆ†é’Ÿ |
| å³°å€¼ GPU æ˜¾å­˜ | 14,147 MiB |
| KV Cache | **PagedAttention** âœ… |
| ä¼˜åŒ– | context_fmha, remove_input_padding |

### Engine é…ç½®
```json
{
  "architecture": "Qwen2ForCausalLM",
  "num_hidden_layers": 32,
  "hidden_size": 4096,
  "max_batch_size": 1,
  "max_input_len": 2048,
  "max_seq_len": 6144,
  "kv_cache_type": "PAGED"
}
```

### è¾“å‡ºæ–‡ä»¶
```
/workspace/models/MOSS-Speech-TRTLLM-Engine/
â”œâ”€â”€ config.json      # 6 KB
â””â”€â”€ rank0.engine     # 6.3 GB
```

## â³ å¾…å®Œæˆ

- [x] æ¨¡å‹æŒä¹…åŒ–åˆ° `/workspace/models/MOSS-Speech/`
- [x] TRT-LLM è‡ªå®šä¹‰æ¶æ„ä»£ç  (`server/trtllm_moss/`)
- [x] æ‰§è¡Œæƒé‡è½¬æ¢ (`convert_v2.py`) âœ…
- [x] æ„å»º TensorRT Engine âœ…
- [ ] åŸºå‡†æµ‹è¯• RTF (ç›®æ ‡: < 1)
- [x] BigVGAN-v2 Vocoder ä¸‹è½½ âœ…
- [ ] BigVGAN é›†æˆæµ‹è¯•
- [ ] WebRTC æ¨æµ

## ğŸ“ æ–°å¢æ–‡ä»¶

```
server/trtllm_moss/
â”œâ”€â”€ __init__.py          # æ¨¡å—å…¥å£
â”œâ”€â”€ model.py             # TRT-LLM è‡ªå®šä¹‰ 32+4 æ¶æ„
â”œâ”€â”€ convert.py           # HuggingFace â†’ TRT-LLM æƒé‡è½¬æ¢
â”œâ”€â”€ inference.py         # æµå¼æ¨ç†è¿è¡Œæ—¶ (å«åˆ†ç‰‡é‡‡æ ·)
â””â”€â”€ build_engine.sh      # ä¸€é”®æ„å»ºè„šæœ¬
```

## ğŸ“ ç¯å¢ƒå®‰è£…å‘½ä»¤ (ä¾›å‚è€ƒ)

```bash
# 1. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv /workspace/envs/trtllm
source /workspace/envs/trtllm/bin/activate

# 2. å®‰è£… TensorRT
pip install tensorrt==10.3.0 --extra-index-url https://pypi.nvidia.com

# 3. å®‰è£… TensorRT-LLM 0.13.0 (CUDA 12.4 å…¼å®¹)
pip install tensorrt-llm==0.13.0 --extra-index-url https://pypi.nvidia.com

# 4. ä¿®å¤ cuda-python ç‰ˆæœ¬
pip install 'cuda-python<13'

# 5. è®¾ç½®ç¯å¢ƒå˜é‡
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/lib64
```

## âš ï¸ å·²çŸ¥é—®é¢˜

1. **pynvml å…¼å®¹æ€§**: éœ€è¦æ‰‹åŠ¨ä¿®è¡¥ `tensorrt_llm/profiler.py`
2. **ç£ç›˜ç©ºé—´**: 50GB é™åˆ¶ï¼Œéœ€å®šæœŸæ¸…ç† `/tmp/pip-unpack-*`

