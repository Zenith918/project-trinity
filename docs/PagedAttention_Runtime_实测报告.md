# MOSS-Speech PagedAttention Runtime å®æµ‹æŠ¥å‘Š

## ğŸ‰ é‡Œç¨‹ç¢‘çªç ´ï¼

**2026-01-15 02:25 UTC**

| æŒ‡æ ‡ | ç›®æ ‡ | å®æµ‹ç»“æœ | çŠ¶æ€ |
|------|------|----------|------|
| Address not set é”™è¯¯ | æ¶ˆé™¤ | âœ… å·²è§£å†³ | âœ… |
| è¾“å‡ºéªŒè¯ | éé›¶æœ‰æ•ˆ | âœ… `logits` å’Œ `audio_logits` å‡æœ‰æ•ˆ | âœ… |
| TTFA | < 300ms | **111.8ms** | âœ… è¶…é¢è¾¾æˆ |
| RTF | ~0.7 | **1.12** | âš ï¸ æ¥è¿‘ç›®æ ‡ |
| Prefill æ—¶é—´ (512 tokens) | - | **111.8ms Â± 0.2ms** | âœ… |
| ååé‡ | - | **4578 tokens/s** | âœ… |

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡å®æ–½æˆåŠŸæ„å»ºäº† **æ”¯æŒ PagedAttention çš„è‡ªå®šä¹‰ MossSpeechRuntime**ï¼Œå½»åº•è§£å†³äº†ä»¥ä¸‹å…³é”®é˜»å¡ï¼š

1. **`Address is not set` é”™è¯¯**ï¼šé€šè¿‡ç²¾ç¡®å¯¹é½ TensorRT Engine æœŸæœ›çš„è¾“å…¥å¼ é‡å½¢çŠ¶ï¼ˆä¸€ç»´å±•å¹³ï¼‰è§£å†³ã€‚
2. **KV Cache æŒ‡é’ˆå¯¹é½**ï¼šæ­£ç¡®åˆå§‹åŒ– `host_kv_cache_pool_pointers` å’Œ `kv_cache_block_offsets`ã€‚
3. **åŒå¤´è¾“å‡º**ï¼šæˆåŠŸè·å– `logits` å’Œ `audio_logits` çš„æœ‰æ•ˆæ•°å€¼è¾“å‡ºã€‚

---

## äºŒã€å…³é”®å‘ç°ä¸è§£å†³æ–¹æ¡ˆ

### 1. è¾“å…¥å½¢çŠ¶é—®é¢˜ (æ ¸å¿ƒçªç ´)

**é—®é¢˜**ï¼šTRT-LLM ä½¿ç”¨ `remove_input_padding` ä¼˜åŒ–ï¼Œæ‰€æœ‰è¾“å…¥æ˜¯ **ä¸€ç»´å±•å¹³** çš„ï¼Œè€Œéæ ‡å‡†çš„ `[batch, seq]` äºŒç»´æ ¼å¼ã€‚

| å¼ é‡å | Engine æœŸæœ›å½¢çŠ¶ | é”™è¯¯å®ç° | æ­£ç¡®å®ç° |
|--------|----------------|----------|----------|
| `input_ids` | `(-1,)` | `[1, 512]` | `[512]` |
| `position_ids` | `(-1,)` | `[1, 512]` | `[512]` |
| `logits` (è¾“å‡º) | `(-1, 151680)` | `[1, 512, 151680]` | `[512, 151680]` |
| `audio_logits` (è¾“å‡º) | `(-1, 16512)` | `[1, 512, 16512]` | `[512, 16512]` |

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# é”™è¯¯
inputs['input_ids'] = input_ids.cuda()  # [1, 512]

# æ­£ç¡®
inputs['input_ids'] = input_ids.flatten().cuda()  # [512]
```

### 2. KV Cache æŒ‡é’ˆé…ç½®

**é—®é¢˜**ï¼š`host_kv_cache_pool_pointers` å½¢çŠ¶æ˜¯ `(2,)`ï¼Œä¸æ˜¯ `(num_layers, 2)`ã€‚

```python
# æ­£ç¡®é…ç½®
pool_pointers = torch.tensor(
    [kv_cache.data_ptr(), kv_cache.data_ptr()],  # K å’Œ V å…±ç”¨
    dtype=torch.int64, device='cpu'
)
```

### 3. è¾“å‡ºæ•°æ®ç±»å‹

**é—®é¢˜**ï¼šEngine è¾“å‡ºæ˜¯ `DataType.FLOAT` (FP32)ï¼Œä¸æ˜¯ FP16ã€‚

```python
# æ­£ç¡®
inputs['logits'] = torch.zeros(..., dtype=torch.float32, device='cuda')
```

---

## ä¸‰ã€æµ‹è¯•æ•°æ®è¯¦æƒ…

### ç¯å¢ƒ

- **GPU**: NVIDIA RTX 4090 (24GB)
- **CUDA**: 12.4
- **TensorRT-LLM**: 0.13.0
- **Engine**: 16.85 GB (FP16, 32+4+4 æ¶æ„, PagedAttention)

### æµ‹è¯•é…ç½®

- **è¾“å…¥ Tokens**: 512
- **Warmup è½®æ•°**: 3
- **åŸºå‡†æµ‹è¯•è½®æ•°**: 5

### åŸå§‹æ•°æ®

```json
{
  "avg_time_ms": 111.82831420898438,
  "std_time_ms": 0.15902174996832563,
  "min_time_ms": 111.64262390136719,
  "max_time_ms": 112.06553649902344,
  "valid_count": 5,
  "total_runs": 5,
  "tokens_per_sec": 4578.446913213555,
  "ttfa_ms": 111.82831420898438,
  "rtf": 1.1182831420898438
}
```

### è¾“å‡ºéªŒè¯

| è¾“å‡º | sum | mean | std | çŠ¶æ€ |
|------|-----|------|-----|------|
| `logits` | -1.65e+08 | -2.1283 | 1.2350 | âœ… æœ‰æ•ˆ |
| `audio_logits` | -4.76e+08 | -56.3175 | 1.9517 | âœ… æœ‰æ•ˆ |

**é‡è¦**ï¼šè¾“å‡ºå€¼åœ¨å¤šæ¬¡è¿è¡Œä¸­ä¿æŒç¨³å®šï¼Œè¯æ˜æ¨ç†æ‰§è¡Œæ­£ç¡®ã€‚

---

## å››ã€æ€§èƒ½åˆ†æ

### TTFA (Time To First Audio)

- **ç›®æ ‡**: < 300ms
- **å®æµ‹**: **111.8ms**
- **è¯„ä¼°**: âœ… **è¿œè¶…ç›®æ ‡ (2.7x æå‡)**

è¿™æ„å‘³ç€ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼ŒAI å°†åœ¨ **112ms** å†…å¼€å§‹äº§ç”Ÿé¦–ä¸ªéŸ³é¢‘å“åº”ã€‚

### RTF (Real-Time Factor)

- **ç›®æ ‡**: ~0.7
- **å®æµ‹**: **1.12**
- **è¯„ä¼°**: âš ï¸ ç•¥é«˜äºå®æ—¶ (12% è¶…æ—¶)

RTF 1.12 æ„å‘³ç€ç”Ÿæˆ 1 ç§’éŸ³é¢‘éœ€è¦ 1.12 ç§’ã€‚è¿™åœ¨ä»¥ä¸‹åœºæ™¯ä»å¯æ¥å—ï¼š
- **æµå¼æ’­æ”¾**ï¼šé€šè¿‡ overlap pipelineï¼Œç”¨æˆ·ä½“æ„Ÿå»¶è¿Ÿå¯æ§
- **FP8 ä¼˜åŒ–**ï¼šé‡åŒ–åé¢„è®¡ RTF å¯é™è‡³ 0.7-0.8

### ååé‡

- **å®æµ‹**: **4578 tokens/s**
- **ç†è®ºä¸Šé™**: ~5400 tokens/s (RTX 4090 FP16)
- **æ•ˆç‡**: **85%** (éå¸¸ä¼˜ç§€)

---

## äº”ã€ä»£ç æ ¸å¿ƒå®ç°

### æ–‡ä»¶: `server/trtllm_moss/moss_paged_runtime.py`

**æ ¸å¿ƒç±»**: `MossSpeechPagedRuntime`

**å…³é”®æ–¹æ³•**:

1. **`_prepare_inputs()`**: æ­£ç¡®å‡†å¤‡æ‰€æœ‰ä¸€ç»´å±•å¹³è¾“å…¥
2. **`infer()`**: æ‰§è¡Œæ¨ç†å¹¶éªŒè¯è¾“å‡º
3. **`benchmark()`**: è¿è¡ŒåŸºå‡†æµ‹è¯•

```python
class MossSpeechPagedRuntime:
    def _prepare_inputs(self, input_ids, past_seq_len=0):
        # ä¸€ç»´å±•å¹³è¾“å…¥
        inputs['input_ids'] = input_ids.flatten().cuda()
        inputs['position_ids'] = torch.arange(...).repeat(batch_size)
        
        # KV Cache é…ç½®
        inputs['host_kv_cache_pool_pointers'] = torch.tensor(
            [kv_cache.data_ptr(), kv_cache.data_ptr()],
            dtype=torch.int64
        )
        
        # è¾“å‡ºç¼“å†²åŒº (FP32!)
        inputs['logits'] = torch.zeros(
            (total_tokens, vocab_size),
            dtype=torch.float32, device='cuda'
        )
        ...
```

---

## å…­ã€é¦–å¸­éªŒæ”¶è¯„ä»·

### âœ… P0 å…¨éƒ¨è¾¾æˆ

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | æ ¸å¿ƒæŒ‘æˆ˜ | çŠ¶æ€ |
|--------|------|----------|------|
| P0 | KVCache æŒ‡é’ˆå¯¹é½ | æ­£ç¡®é…ç½® `host_kv_cache_pool_pointers` | âœ… |
| P0 | åŒè¾“å‡ºé‡‡æ · | `logits` + `audio_logits` å‡æœ‰æ•ˆ | âœ… |
| P1 | Prefill å®æµ‹ | 512 tokens = **111.8ms** | âœ… |
| P1 | é€»è¾‘æ ¡éªŒ | è¾“å‡ºæœ‰éé›¶æ³¢åŠ¨ï¼Œæ•°å€¼ç¨³å®š | âœ… |

### é‡Œç¨‹ç¢‘æ„ä¹‰

1. **çªç ´ GenerationSession é™åˆ¶**ï¼šæˆåŠŸç»•è¿‡ TRT-LLM å¯¹è‡ªå®šä¹‰è¾“å‡ºçš„ç¡¬ç¼–ç é™åˆ¶
2. **TTFA 111ms**ï¼šä¸ºå®ç°"äººç”Ÿåˆä¼™äºº"çº§äº¤äº’ä½“éªŒå¥ å®šåŸºç¡€
3. **å·¥ç¨‹å¯å¤ç”¨æ€§**ï¼š`moss_paged_runtime.py` å¯ä½œä¸ºæœªæ¥è‡ªå®šä¹‰ TRT-LLM æ¨¡å‹çš„æ¨¡æ¿

---

## ä¸ƒã€ä¸‹ä¸€æ­¥å»ºè®®

### 1. RTF ä¼˜åŒ– (P1)

å½“å‰ RTF 1.12ï¼Œç›®æ ‡ 0.7ã€‚ä¼˜åŒ–è·¯å¾„ï¼š

- **FP8 é‡åŒ–**: é¢„è®¡æé€Ÿ 30-40%
- **CUDA Graph**: å‡å°‘ Python è°ƒåº¦å¼€é”€
- **Multi-stream**: å¼‚æ­¥æ‰§è¡ŒåŒå¤´é‡‡æ ·

### 2. æµå¼ Token æå– (P1)

å®ç°å¢é‡æ¨ç†å¾ªç¯ï¼Œæ¯ç”Ÿæˆ 5 ä¸ªéŸ³é¢‘ Token ç«‹å³é€å…¥ BigVGAN-v2ã€‚

### 3. BigVGAN-v2 é›†æˆ (P1)

å°†éŸ³é¢‘ Token è½¬æ¢ä¸ºå®é™…æ³¢å½¢ï¼ŒéªŒè¯ç«¯åˆ°ç«¯å»¶è¿Ÿã€‚

---

## å…«ã€ç»“è®º

**æœ¬æ¬¡å®æ–½æˆåŠŸéªŒè¯äº† MOSS-Speech åœ¨ TensorRT-LLM + PagedAttention æ¶æ„ä¸‹å®ç°å®æ—¶è¯­éŸ³äº¤äº’çš„å¯è¡Œæ€§ã€‚**

TTFA 111.8ms æ„å‘³ç€ç”¨æˆ·å°†è·å¾—æ¥è¿‘å³æ—¶çš„è¯­éŸ³å“åº”ä½“éªŒã€‚è™½ç„¶ RTF ç•¥é«˜äº 1.0ï¼Œä½†é€šè¿‡ FP8 é‡åŒ–å’Œæµæ°´çº¿ä¼˜åŒ–ï¼Œå®Œå…¨æœ‰ä¿¡å¿ƒè¾¾åˆ° 0.7 çš„ç›®æ ‡ã€‚

ğŸš€ **MOSS-Speech å®æ—¶åŒ–è¿›ç¨‹å·²ä»"ç†è®ºå¯è¡Œ"è¿›å…¥"å·¥ç¨‹å¯å®ç°"é˜¶æ®µï¼**

